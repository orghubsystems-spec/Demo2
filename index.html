<!DOCTYPE html>
<html lang="pl">
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      font-family: Collage, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #000;
      color: #fff;
      text-align: center;
    }

    .hidden { display: none !important; }
    .container { margin-top: 40px; }

    .login-box input, .login-box select {
      display: block;
      margin: 10px auto;
      padding: 8px;
      width: 200px;
      border-radius: 6px;
      border: none;
    }

    button {
      padding: 8px 16px;
      border: none;
      background: red;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    button[disabled] { background: gray !important; cursor: default; }

    .full-btn {
      display: block;
      width: 200px;
      margin: 10px auto;
      padding: 8px;
      border-radius: 6px;
      background: red;
      border: none;
      color: white;
      cursor: pointer;
    }
    .full-btn.alt { background: #333; }

    .card {
      border: 1px solid #555;
      border-radius: 10px;
      padding: 10px;
      margin: 10px;
      background: #111;
    }

    .lista-zapisanych {
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      padding: 8px;
      margin-top: 6px;
      text-align: left;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    #wersjaApki {
      position: fixed;
      top: 8px;
      right: 12px;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      user-select: none;
      z-index: 1000;
    }

    button.loading {
      background: #222 !important;
      opacity: 0.6;
      pointer-events: none;
      transition: background 0.2s ease, opacity 0.2s ease;
    }

    /* Splash */
    #splash {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #000;
    }
    .logo-fadein {
      width: 300px;
      opacity: 0;
      filter: brightness(20%) blur(2px);
      transform: scale(0.2);
      animation: wjazdLogo 5s ease-out forwards;
    }
    @keyframes wjazdLogo {
      0%   { opacity: 0; transform: scale(0.2); filter: brightness(20%) blur(4px); }
      60%  { opacity: 1; transform: scale(1.1); filter: brightness(160%) blur(0); }
      85%  { opacity: 1; transform: scale(1);   filter: brightness(100%); }
      100% { opacity: 0; transform: scale(1);   filter: brightness(50%) blur(2px); }
    }

    .select-like-input {
      width: 200px;
      height: 36px;
      margin: 10px auto;
      border-radius: 6px;
      border: none;
      padding: 6px;
      font-size: 14px;
      display: block;
    }

    .grupa-check {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 14px;
      color: white;
    }
    .grupa-check input {
      margin-bottom: 4px;
      transform: scale(1.3);
    }

    .btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      background: #444;
      color: #fff;
      cursor: pointer;
      margin: 2px;
    }
    .btn.danger { background: #800; }

    #trainerDeletePopup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 2000;
      display: none;
    }
    #trainerDeletePopup.show { display: flex; }
    #trainerDeletePopup .popup-card {
      background: #111;
      border: 1px solid #555;
      border-radius: 10px;
      padding: 16px 20px;
      max-width: 260px;
      text-align: center;
    }

    /* BUSY OVERLAY */
    #busyOverlay.hidden { display: none !important; }
    #busyOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 5000;
      padding: 24px;
    }

    button, input, select { font-size: 14px; }
  </style>
  <script> const WERSJA_APKI = '1.02.03.02';
    const poprzednia = localStorage.getItem('wersjaApki');
    if (poprzednia !== WERSJA_APKI) {
      localStorage.setItem('wersjaApki', WERSJA_APKI);
      location.reload(true);
        } 
    if ('serviceWorker' in navigator) { 
      navigator.serviceWorker.register('service-worker.js') 
        .then(r => console.log("‚úÖ SW zarejestrowany:", r)) 
        .catch(e => console.error("‚ùå B≈ÇƒÖd SW:", e)); 
    } 
  </script>
</head>

<body>

  <div id="wersjaApki"><span id="wersjaNum"></span></div>

  <!-- BUSY OVERLAY (jeden, zgodny z JS: busyText) -->
  <div id="busyOverlay" class="hidden">
    <div style="font-size:20px; margin-bottom:12px;">‚è≥ Przygotowujƒô aplikacjƒô‚Ä¶</div>
    <div id="busyText" style="opacity:.85; max-width:320px; line-height:1.4;">
      Tworzƒô pliki klubu, ustawiam sezon i konfiguracjƒô.
    </div>
  </div>

  <!-- Splash -->
  <div id="splash">
    <img src="icon-512.png" class="logo-fadein" alt="Logo">
  </div>

  <!-- G≈Ç√≥wna aplikacja -->
  <div id="app" class="hidden">

    <!-- LANDING ORGHUB -->
    <div id="orgHubLandingView" class="container hidden">
      <h1 style="margin-bottom:8px;">ORGHUB SYSTEMS</h1>
      <p style="opacity:0.8;margin-top:0;">Panel startowy</p>
      <button class="full-btn" onclick="goToConfig()">Skonfiguruj klub</button>
    </div>

    <!-- KONFIGURACJA KLUBU -->
    <div id="clubConfigView" class="container hidden">
      <h1>Konfiguracja klubu</h1>

      <div class="card" style="max-width:320px;margin:12px auto;">
        <!-- LOGO -->
        <button class="full-btn" onclick="pickLogo()">Wgraj swoje logo</button>
        <div style="margin-top:8px;">
          <img id="cfgLogoPreview" src="" alt="" style="display:none;width:160px;border-radius:10px;border:1px solid #444;">
          <div style="font-size:12px;opacity:0.75;margin-top:6px;">
            PNG/JPG, najlepiej kwadrat, np. 512√ó512
          </div>
          <input id="cfgLogoInput" type="file" accept="image/*" class="hidden" />
        </div>

        <!-- NAZWA (zgodnie z JS: editClubName) -->
        <button class="full-btn alt" onclick="editClubName()">Podaj nazwƒô klubu</button>
        <div id="cfgClubNameLabel" style="margin-top:6px;opacity:0.9;"></div>

        <!-- SEZON START -->
        <button class="full-btn alt" onclick="editSeasonStart()">PoczƒÖtek sezonu</button>
        <div id="cfgSeasonStartLabel" style="margin-top:6px;opacity:0.9;"></div>

        <!-- SEZON END -->
        <button class="full-btn alt" onclick="editSeasonEnd()">Koniec sezonu</button>
        <div id="cfgSeasonEndLabel" style="margin-top:6px;opacity:0.9;"></div>

        <!-- KOLOR T≈ÅA -->
        <button class="full-btn alt" onclick="toggleColorPicker(true)">Wybierz kolor t≈Ça</button>
        <div id="cfgColorLabel" style="margin-top:6px;opacity:0.9;"></div>

        <div id="cfgColorGrid" class="hidden"
             style="margin-top:10px;display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;">
        </div>

        <!-- EMAIL -->
        <button class="full-btn alt" onclick="editEmail()">Tw√≥j email</button>
        <div id="cfgEmailLabel" style="margin-top:6px;opacity:0.9;"></div>

        <button class="full-btn" style="margin-top:14px;" onclick="submitClubConfig()">Wy≈õlij</button>
        <button class="full-btn alt" onclick="goBackFromConfig()">‚¨Ö Powr√≥t</button>

        <p id="cfgMsg" style="margin-top:10px;"></p>
      </div>
    </div>

    <!-- LOGOWANIE -->
    <div id="loginView" class="container hidden">
      <img src="icon-512.png" class="logo" style="width:200px;margin-bottom:20px;" alt="Logo">
      <h1>Logowanie</h1>
      <div style="opacity:.8; margin-bottom:10px;">
        Club: <b id="clubIdBadge"></b>
      </div>
      <div class="login-box">
        <input id="numer" type="text" placeholder="Numer / Inicja≈Çy">
        <input id="haslo" type="password" placeholder="Has≈Ço">
        <button class="full-btn" onclick="zaloguj()">Zaloguj</button>
        <button class="full-btn alt" onclick="pokazRejestracjaSelect()">Rejestracja</button>
      </div>
      <p id="komunikat"></p>
    </div>

    <!-- WYB√ìR TYP REJESTRACJI -->
    <div id="registerSelectView" class="container hidden">
      <h1>Rejestracja</h1>
      <button class="full-btn" onclick="pokazRejestracjaZawodnik()">Zawodnik</button>
      <button class="full-btn" onclick="pokazRejestracjaTrener()">Trener</button>
      <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>
    </div>

    <!-- REJESTRACJA ZAWODNIKA -->
    <div id="registerZawodnikView" class="container hidden">
      <h1>Rejestracja zawodnika</h1>
      <div class="login-box">
        <input id="regNumer" type="number" placeholder="Numer zawodnika">
        <input id="regNazwisko" type="text" placeholder="Imiƒô i nazwisko">
        <input id="regHaslo" type="password" placeholder="Ustaw has≈Ço">
        <button class="full-btn" onclick="wyslijRejestracje()">Zarejestruj</button>
      </div>
      <p id="regMsg"></p>
      <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>
    </div>

    <!-- REJESTRACJA TRENERA -->
    <div id="rejestracjaTrenerView" class="container hidden">
      <h1>Rejestracja trenera</h1>
      <div class="login-box">
        <input id="regNazwiskoTrener" type="text" placeholder="Imiƒô i nazwisko">
        <input id="regHasloTrener" type="password" placeholder="Ustaw has≈Ço">
        <button class="full-btn" onclick="wyslijRejestracjeTrener()">Zarejestruj</button>
        <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>
      </div>
      <p id="regMsgTrener"></p>
    </div>

    <!-- DODAJ WYDARZENIE (TRENER) -->
    <div id="trainerDodajWydarzenieView" class="container hidden">
      <h1>Dodaj wydarzenie</h1>
      <div class="login-box">
        <input id="eventData" type="date">
        <input id="eventStart" type="time">
        <input id="eventEnd" type="time">
        <input id="eventRodzaj" type="text" placeholder="Rodzaj wydarzenia">

        <select id="eventTrener1" class="select-like-input">
          <option value="">‚Äî wybierz trenera ‚Äî</option>
        </select>
        <select id="eventTrener2" class="select-like-input">
          <option value="">‚Äî brak ‚Äî</option>
        </select>
      </div>

      <div style="display:flex; justify-content:center; gap:25px; margin:20px auto 10px auto; width:260px;">
        <label class="grupa-check"><input type="checkbox" class="eventGrupa" value="G1"><span>G1</span></label>
        <label class="grupa-check"><input type="checkbox" class="eventGrupa" value="G2"><span>G2</span></label>
        <label class="grupa-check"><input type="checkbox" class="eventGrupa" value="G3"><span>G3</span></label>
        <label class="grupa-check"><input type="checkbox" class="eventGrupa" value="G4"><span>G4</span></label>
        <label class="grupa-check"><input type="checkbox" class="eventGrupa" value="G5"><span>G5</span></label>
      </div>

      <div style="margin-top:10px;">
        <label><input id="eventStat" type="checkbox"> Liczyƒá do statystyk</label>
      </div>

      <button class="full-btn" onclick="wyslijNoweWydarzenie()">üíæ Dodaj wydarzenie</button>
      <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>
      <p id="eventMsg" style="margin-top:10px;"></p>
    </div>

    <!-- P≈ÅATNO≈öCI -->
    <div id="platnosciView" class="container hidden">
      <h1>P≈Çatno≈õci</h1>
      <div id="listaPlatnosci">≈Åadowanie...</div>
    </div>

    <!-- WYDARZENIA (ZAWODNIK) -->
    <div id="homeView" class="container hidden">
      <h1 id="tytulTreningow">TWOJE WYDARZENIA</h1>
      <div id="listaTreningow">≈Åadowanie...</div>
      <button onclick="pokazStatystyki()" style="margin-top:20px;">üìà Poka≈º statystyki</button>
      <button onclick="powrotDoPlatnosci()" style="margin-top:10px;background:#333;">‚¨Ö Powr√≥t do p≈Çatno≈õci</button>
    </div>

    <!-- STATYSTYKI -->
    <div id="statsView" class="container hidden">
      <h1>Moje statystyki</h1>
      <div id="listaStatystyk">≈Åadowanie...</div>
      <button onclick="powrotDoTreningow()" style="margin-top:20px;">‚¨Ö Powr√≥t</button>
    </div>

    <!-- PANEL TRENERA -->
    <div id="trainerPanelView" class="container hidden">
      <h1>Panel trenera</h1>
      <button class="full-btn" onclick="trainerPokazZawodnicy()">üë• Zawodnicy</button>
      <button class="full-btn" onclick="trainerPokazWydarzenia()">üèí Wydarzenia</button>
      <button class="full-btn alt" onclick="pokazLogowanie()">‚¨Ö Wyloguj</button>
    </div>

    <!-- LISTA ZAWODNIK√ìW (TRENER) -->
    <div id="trainerZawodnicyView" class="container hidden">
      <h1>Lista zawodnik√≥w</h1>
      <div id="trainerListaZawodnikow">≈Åadowanie...</div>
      <button class="full-btn alt" onclick="trainerPowrot()">‚¨Ö Powr√≥t</button>
    </div>

    <!-- WYDARZENIA (TRENER) -->
    <div id="trainerWydarzeniaView" class="container hidden">
      <h1>Wydarzenia</h1>
      <div id="trainerListaWydarzen">≈Åadowanie...</div>
      <button class="full-btn" style="margin-top:20px;" onclick="pokazDodajWydarzenie()">‚ûï Dodaj wydarzenie</button>
      <button class="full-btn alt" onclick="trainerPowrot()">‚¨Ö Powr√≥t</button>
    </div>

    <!-- Popup potwierdzenia usuniƒôcia -->
    <div id="trainerDeletePopup">
      <div class="popup-card">
        <p style="margin-bottom:15px;">Czy napewno chcesz usunƒÖƒá wydarzenie ?</p>
        <button class="full-btn" onclick="trainerConfirmDeleteYes()">TAK</button>
        <button class="full-btn alt" style="margin-top:8px;" onclick="trainerHideDeletePopup()">Anuluj</button>
      </div>
    </div>

  </div><!-- /app -->

<script>
/* =================== 00 START / INTRO =================== */
function odtworzIntroSound() {
  try {
    const audio = new Audio("sound.mp3");
    audio.volume = 0.7;
    audio.play().catch(() => {});
  } catch (err) {}
}

/* =================== 10 KONFIG / GLOBALNE =================== */
const WERSJA_APKI = window.WERSJA_APKI || "ORGHUB APP";
const CORE_URL = "https://script.google.com/macros/s/AKfycbwn7Zb9uotc34HNLAsr79r5G5ctr2G2PzIxmZZFyQfeDD2Q8vecZCArQ-ezKVB5TcOexw/exec";

// stan aplikacji
let clubId = localStorage.getItem("orghub_clubId") || "";
let numerZalogowanego = null;
let grupaZalogowanego = null;
window.grupyTrenera = "";
let currentView = "loginView";

/* =================== 20 PAMIƒòƒÜ LOKALNA (localStorage) =================== */
const LS_KEY_CFG = "orghub.clubConfig.v1";
const LS_KEY_CLUBID = "orghub_clubId";
const LS_KEY_THEME = "orghub_theme";

function loadLocalClubConfig() {
  try { return JSON.parse(localStorage.getItem(LS_KEY_CFG) || "null"); }
  catch { return null; }
}
function saveLocalClubConfig(cfg) {
  localStorage.setItem(LS_KEY_CFG, JSON.stringify(cfg || {}));
}
function clearLocalClubConfig() {
  localStorage.removeItem(LS_KEY_CFG);
}
function saveClubId_(id) {
  clubId = String(id || "").trim();
  if (clubId) localStorage.setItem(LS_KEY_CLUBID, clubId);
  else localStorage.removeItem(LS_KEY_CLUBID);
}
function saveTheme_(theme) {
  localStorage.setItem(LS_KEY_THEME, JSON.stringify(theme || {}));
}
function loadTheme_() {
  try { return JSON.parse(localStorage.getItem(LS_KEY_THEME) || "null"); }
  catch { return null; }
}

/* =================== 30 BUSY OVERLAY =================== */
function showBusy(text) {
  const ov = document.getElementById("busyOverlay");
  const bt = document.getElementById("busyText");
  if (bt && text) bt.textContent = text;
  if (ov) ov.classList.remove("hidden");
}
function hideBusy() {
  const ov = document.getElementById("busyOverlay");
  if (ov) ov.classList.add("hidden");
}

/* =================== 40 NAWIGACJA / ROUTER =================== */
function ukryjWszystkie() {
  document.querySelectorAll(".container").forEach(v => v.classList.add("hidden"));
}

function goToView(viewId, options = {}) {
  const { replace = false } = options;
  ukryjWszystkie();
  const el = document.getElementById(viewId);
  if (el) el.classList.remove("hidden");
  currentView = viewId;

  const state = { view: viewId };
  try {
    if (replace) history.replaceState(state, "", "");
    else history.pushState(state, "", "");
  } catch (e) {}
}

function showViewFromHistory(viewId) {
  ukryjWszystkie();
  const el = document.getElementById(viewId);
  if (el) el.classList.remove("hidden");
  currentView = viewId;
}

function appBack() { history.back(); }

window.addEventListener("popstate", (event) => {
  const state = event.state;
  if (state && state.view) showViewFromHistory(state.view);
  else showViewFromHistory(clubId ? "loginView" : "orgHubLandingView");
});

function refreshClubBadge_() {
  const el = document.getElementById("clubIdBadge");
  if (el) el.textContent = clubId || "‚Äî";
}

function applyTheme_(theme) {
  try {
    if (theme?.bgColor) document.body.style.backgroundColor = theme.bgColor;

    const logoImg = document.querySelector("#loginView img.logo") || document.querySelector("#loginView img");
    if (logoImg && theme?.logoUrl) logoImg.src = theme.logoUrl;

  } catch (e) {}
}

function startApp_() {
  // zastosuj theme je≈õli jest
  const t = loadTheme_();
  if (t) applyTheme_(t);

  refreshClubBadge_();
  goToView(clubId ? "loginView" : "orgHubLandingView", { replace: true });
}

/* =================== 50 API (CORE / CLUB) =================== */
function requireClubId() {
  if (!clubId) throw new Error("Brak clubId. Najpierw skonfiguruj klub.");
}

// POST do CORE bez clubId (np. createClub)
async function apiCorePost(payload = {}) {
  const body = new URLSearchParams({ ...payload });
  const res = await fetch(CORE_URL, { method: "POST", body });
  return res.json();
}

// GET/POST do CLUB (wymaga clubId)
async function apiClubGet(action, params = {}) {
  requireClubId();
  const url = new URL(CORE_URL);
  url.searchParams.set("action", action);
  url.searchParams.set("clubId", clubId);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v ?? ""));
  const res = await fetch(url.toString(), { cache: "no-store" });
  return res.json();
}

async function apiClubPost(payload = {}) {
  requireClubId();
  const body = new URLSearchParams({ clubId, ...payload });
  const res = await fetch(CORE_URL, { method: "POST", body });
  return res.json();
}

/* =================== 60 ORGHUB START / KONFIGURACJA =================== */
// Tu masz dwa widoki: orgHubLandingView (start) i clubConfigView (panel)
// Docelowo zrobimy ‚Äúprzycisk zamienia siƒô w input‚Äù ‚Äî ale to bƒôdzie kolejny krok.

let cfgDraft = {
  clubName: "",
  email: "",
  sezonStart: "", // YYYY-MM-01
  sezonEnd: "",   // YYYY-MM-30 (tymczasowo)
  bgColor: "#000000",
  logoDataUrl: "" // dataURL
};

// paleta (wiƒôcej kolor√≥w zrobimy w nastƒôpnym kroku)
const COLOR_PRESETS = [
  "#000000","#111111","#1b1b1b","#2a2a2a",
  "#0b1220","#0f1a2b","#132235","#1a2f4a",
  "#1a0f1f","#2a1232","#3a1444","#4a1757",
  "#102015","#15301f","#1a4028","#205232",
];

function renderConfigUI_() {
  const nameEl = document.getElementById("cfgClubNameLabel");
  const ssEl = document.getElementById("cfgSeasonStartLabel");
  const seEl = document.getElementById("cfgSeasonEndLabel");
  const emEl = document.getElementById("cfgEmailLabel");
  const colEl = document.getElementById("cfgColorLabel");
  const prev = document.getElementById("cfgLogoPreview");
  const grid = document.getElementById("cfgColorGrid");

  if (nameEl) nameEl.textContent = cfgDraft.clubName ? `‚úÖ ${cfgDraft.clubName}` : "‚Äî nie ustawiono";
  if (ssEl) ssEl.textContent = cfgDraft.sezonStart ? `‚úÖ ${cfgDraft.sezonStart}` : "‚Äî nie ustawiono";
  if (seEl) seEl.textContent = cfgDraft.sezonEnd ? `‚úÖ ${cfgDraft.sezonEnd}` : "‚Äî nie ustawiono";
  if (emEl) emEl.textContent = cfgDraft.email ? `‚úÖ ${cfgDraft.email}` : "‚Äî nie ustawiono";
  if (colEl) colEl.textContent = cfgDraft.bgColor ? `‚úÖ ${cfgDraft.bgColor}` : "‚Äî nie ustawiono";

  if (prev) {
    if (cfgDraft.logoDataUrl) {
      prev.src = cfgDraft.logoDataUrl;
      prev.style.display = "inline-block";
    } else {
      prev.style.display = "none";
    }
  }

  if (grid) {
    grid.innerHTML = COLOR_PRESETS.map(c => `
      <div onclick="setBgColor('${c}')" style="
        width:100%; aspect-ratio:1/1; border-radius:10px;
        border:1px solid #444; background:${c}; cursor:pointer;">
      </div>
    `).join("");
  }
}

function goToConfig() {
  const saved = loadLocalClubConfig();
  if (saved) cfgDraft = { ...cfgDraft, ...saved };

  renderConfigUI_();
  goToView("clubConfigView");
}

function goBackFromConfig() {
  goToView(clubId ? "loginView" : "orgHubLandingView");
}

function toggleColorPicker(show) {
  const grid = document.getElementById("cfgColorGrid");
  if (!grid) return;
  if (show) grid.classList.remove("hidden");
  else grid.classList.add("hidden");
}

function setBgColor(color) {
  cfgDraft.bgColor = color;
  document.body.style.backgroundColor = color;
  const colEl = document.getElementById("cfgColorLabel");
  if (colEl) colEl.textContent = `‚úÖ ${color}`;
}

function pickLogo() {
  const input = document.getElementById("cfgLogoInput");
  if (!input) return;

  input.onchange = async () => {
    const file = input.files && input.files[0];
    if (!file) return;

    if (file.size > 2 * 1024 * 1024) {
      const msg = document.getElementById("cfgMsg");
      if (msg) msg.textContent = "‚ùå Logo za du≈ºe (max ~2MB).";
      return;
    }

    cfgDraft.logoDataUrl = await fileToDataUrl_(file);
    renderConfigUI_();
  };

  input.click();
}

function fileToDataUrl_(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result || ""));
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

// Tymczasowo jeszcze u≈ºywamy prompt√≥w. Ty chcesz inline-input w przycisku ‚Äî zrobimy w kolejnym kroku.
function editClubName() {
  const v = prompt("Podaj nazwƒô klubu:", cfgDraft.clubName || "");
  if (v === null) return;
  cfgDraft.clubName = v.trim();
  renderConfigUI_();
}
function editEmail() {
  const v = prompt("Podaj email admina:", cfgDraft.email || "");
  if (v === null) return;
  cfgDraft.email = v.trim();
  renderConfigUI_();
}
function editSeasonStart() {
  const v = prompt("PoczƒÖtek sezonu (RRRR-MM), np. 2026-09:", cfgDraft.sezonStart ? cfgDraft.sezonStart.slice(0,7) : "");
  if (v === null) return;
  const m = String(v).trim();
  if (!/^\d{4}-\d{2}$/.test(m)) {
    const msg = document.getElementById("cfgMsg");
    if (msg) msg.textContent = "‚ùå Z≈Çy format. U≈ºyj RRRR-MM.";
    return;
  }
  cfgDraft.sezonStart = `${m}-01`;
  renderConfigUI_();
}
function editSeasonEnd() {
  const v = prompt("Koniec sezonu (RRRR-MM), np. 2027-04:", cfgDraft.sezonEnd ? cfgDraft.sezonEnd.slice(0,7) : "");
  if (v === null) return;
  const m = String(v).trim();
  if (!/^\d{4}-\d{2}$/.test(m)) {
    const msg = document.getElementById("cfgMsg");
    if (msg) msg.textContent = "‚ùå Z≈Çy format. U≈ºyj RRRR-MM.";
    return;
  }
  cfgDraft.sezonEnd = `${m}-30`; // backend doprecyzuje
  renderConfigUI_();
}

/* =================== 61 WYS≈ÅANIE KONFIGURACJI -> CREATECLUB =================== */
function validateCfg_() {
  if (!cfgDraft.logoDataUrl) return "Wgraj logo.";
  if (!cfgDraft.clubName) return "Podaj nazwƒô klubu.";
  if (!cfgDraft.sezonStart) return "Podaj poczƒÖtek sezonu.";
  if (!cfgDraft.sezonEnd) return "Podaj koniec sezonu.";
  if (!cfgDraft.bgColor) return "Wybierz kolor t≈Ça.";
  if (!cfgDraft.email) return "Podaj email admina.";
  if (cfgDraft.sezonStart > cfgDraft.sezonEnd) return "PoczƒÖtek sezonu nie mo≈ºe byƒá po ko≈Ñcu sezonu.";
  return "";
}

async function submitClubConfig() {
  const msg = document.getElementById("cfgMsg");
  if (msg) msg.textContent = "";

  const err = validateCfg_();
  if (err) {
    if (msg) msg.textContent = "‚ùå " + err;
    return;
  }

  // zapis roboczy lokalnie (≈ºeby nie zginƒô≈Ço po od≈õwie≈ºeniu)
  saveLocalClubConfig({ ...cfgDraft });

  showBusy("Tworzƒô pliki klubu i konfiguracjƒô sezonu‚Ä¶");

  try {
    const r = await apiCorePost({
      action: "createClub",
      clubName: cfgDraft.clubName,
      sezonStart: cfgDraft.sezonStart,
      sezonEnd: cfgDraft.sezonEnd,
      bgColor: cfgDraft.bgColor,
      ownerEmail: cfgDraft.email,
      logoBase64: cfgDraft.logoDataUrl
    });

    if (!r || (r.success !== true && r.ok !== true)) {
      hideBusy();
      if (msg) msg.textContent = "‚ùå " + (r?.error || r?.message || JSON.stringify(r));
      return;
    }

    if (!r.clubId) {
      hideBusy();
      if (msg) msg.textContent = "‚ùå CORE nie zwr√≥ci≈Ç clubId.";
      return;
    }

    // ustaw clubId
    saveClubId_(r.clubId);

    // theme
    const theme = {
      bgColor: r.bgColor || cfgDraft.bgColor,
      logoUrl: r.logoUrl || cfgDraft.logoDataUrl, // je≈õli CORE nie hostuje jeszcze logo, u≈ºyj dataUrl
      clubName: r.clubName || cfgDraft.clubName
    };
    saveTheme_(theme);
    applyTheme_(theme);

    // utrwal config (z clubId)
    saveLocalClubConfig({ ...cfgDraft, clubId: r.clubId });

    hideBusy();
    if (msg) msg.textContent = "‚úÖ Gotowe. Przechodzƒô do logowania‚Ä¶";

    refreshClubBadge_();
    setTimeout(() => goToView("loginView", { replace:true }), 400);

  } catch (e) {
    hideBusy();
    if (msg) msg.textContent = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e);
  }
}

/* =================== 70 LOGOWANIE / REJESTRACJA =================== */
function pokazLogowanie() {
  numerZalogowanego = null;
  grupaZalogowanego = null;
  window.grupyTrenera = "";
  refreshClubBadge_();
  goToView("loginView");
}
function pokazRejestracjaSelect() { goToView("registerSelectView"); }
function pokazRejestracjaZawodnik() { goToView("registerZawodnikView"); }
function pokazRejestracjaTrener() { goToView("rejestracjaTrenerView"); }

async function zaloguj() {
  const login = document.getElementById("numer").value.trim();
  const haslo = document.getElementById("haslo").value.trim();
  const komunikat = document.getElementById("komunikat");

  if (!clubId) { komunikat.innerText = "Najpierw skonfiguruj klub."; goToView("orgHubLandingView"); return; }
  if (!login || !haslo) { komunikat.innerText = "Podaj login i has≈Ço."; return; }

  komunikat.innerText = "Trwa logowanie...";

  try {
    const data = await apiClubPost({ mode: "login", numer: login, haslo });

    if (!data.success) {
      komunikat.innerText = "‚ùå " + (data.message || "B≈ÇƒÖd logowania");
      return;
    }

    komunikat.innerText = "‚úÖ Zalogowano";

    if (data.role === "zawodnik") {
      numerZalogowanego = data.login;
      grupaZalogowanego = data.grupa || "";

      const platnosci = await apiClubGet("platnosci", { numer: numerZalogowanego });
      if (Array.isArray(platnosci) && platnosci.length > 0) {
        goToView("platnosciView");
        renderPlatnosci(platnosci);
        return;
      }

      await pokazTreningi();
      return;
    }

    if (data.role === "trener") {
      window.grupyTrenera = data.grupa || "";
      goToView("trainerPanelView");
      return;
    }

  } catch (e) {
    komunikat.innerText = "B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e);
  }
}

/* =================== 75 REJESTRACJA =================== */
async function wyslijRejestracje() {
  const numer = document.getElementById("regNumer").value.trim();
  const nazwisko = document.getElementById("regNazwisko").value.trim();
  const haslo = document.getElementById("regHaslo").value.trim();
  const msg = document.getElementById("regMsg");

  if (!numer || !nazwisko || !haslo) { msg.innerText = "Wype≈Çnij wszystkie pola."; return; }

  msg.innerText = "‚è≥ Rejestracja...";
  try {
    const data = await apiClubPost({ mode: "rejestracja", numer, nazwisko, haslo });

    if (data.ok) {
      document.getElementById("regNumer").value = "";
      document.getElementById("regNazwisko").value = "";
      document.getElementById("regHaslo").value = "";
      msg.innerText = "‚úÖ Rejestracja zako≈Ñczona!";
      setTimeout(() => { msg.innerText = ""; pokazLogowanie(); }, 1500);
    } else {
      msg.innerText = "‚ùå " + (data.msg || "B≈ÇƒÖd");
    }
  } catch (e) {
    msg.innerText = "B≈ÇƒÖd po≈ÇƒÖczenia.";
  }
}

async function wyslijRejestracjeTrener() {
  const poleNazw = document.getElementById("regNazwiskoTrener");
  const poleHaslo = document.getElementById("regHasloTrener");
  const msg = document.getElementById("regMsgTrener");

  const nazwisko = poleNazw.value.trim();
  const haslo = poleHaslo.value.trim();
  if (!nazwisko || !haslo) { msg.innerText = "Wype≈Çnij wszystkie pola."; return; }

  msg.innerText = "‚è≥ Rejestracja...";
  try {
    const data = await apiClubPost({ mode: "rejestracjaTrener", nazwisko, haslo });

    if (data.ok) {
      const inic = data.inic || "(?)";
      msg.innerHTML = `
        ‚úÖ <b>Zarejestrowano trenera!</b><br>
        Login do systemu: <b>${inic}</b><br><br>
        <button class="full-btn" onclick="navigator.clipboard.writeText('${inic}')">üìã Skopiuj login</button>
      `;
      poleNazw.value = "";
      poleHaslo.value = "";
      setTimeout(() => { msg.innerText = ""; pokazLogowanie(); }, 8000);
    } else {
      msg.innerText = "‚ùå " + (data.msg || "B≈ÇƒÖd");
    }
  } catch (e) {
    msg.innerText = "B≈ÇƒÖd po≈ÇƒÖczenia.";
  }
}

/* =================== 80 ZAWODNIK: TRENINGI / ZAPISY =================== */
function renderPlatnosci(lista) {
  const div = document.getElementById("listaPlatnosci");
  if (!lista?.length) {
    div.innerHTML = "<p>Brak zaleg≈Ço≈õci ‚úÖ</p>" +
      "<button class='full-btn' onclick='pokazTreningi()'>Dalej ‚û°</button>";
    return;
  }

  div.innerHTML =
    "<h3>Zaleg≈Çe p≈Çatno≈õci:</h3>" +
    lista.map(p => `<div class='card' style='background:#a00;'>üî¥ ${p.nazwa} ‚Äì ${p.kwota} z≈Ç</div>`).join('') +
    `<button class='full-btn' onclick='pokazTreningi()' style='margin-top:20px;'>Dalej ‚û°</button>`;
}

async function pokazTreningi() {
  goToView("homeView");
  const lista = await apiClubGet("treningi", { grupa: grupaZalogowanego, numer: numerZalogowanego });
  renderTreningi(lista);
}

function renderTreningi(lista) {
  const div = document.getElementById('listaTreningow');
  if (!lista?.length) { div.innerHTML = "<p>Brak wydarze≈Ñ</p>"; return; }

  div.innerHTML = lista.map(t => `
    <div class="card">
      <p>
        <b>${t.rodzaj}</b> &nbsp;&nbsp; ${t.data} (${t.dzien})<br>
        Godzina: <b>${t.godzStart}</b> ‚Äì <b>${t.godzKoniec}</b><br>
        Trener: <b>${t.trener}</b> &nbsp;&nbsp; Zapisanych: ${t.zapisanych}
      </p>

      <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;">
        <button id="btn-${t.id}" ${t.zapisany ? 'disabled' : ''} onclick="zapiszSie('${t.id}')">
          ${t.zapisany ? 'Zapisano ‚úÖ' : 'Zapisz siƒô'}
        </button>
        <button id="wypisz-${t.id}" ${t.zapisany ? '' : 'disabled'} style="background:#444;" onclick="wypiszSie('${t.id}')">
          Wypisz siƒô
        </button>
        <button style="background:#333;" onclick="toggleZapisani('${t.id}')">üë• Zapisani</button>
      </div>

      <div id="zapisani-${t.id}" class="hidden lista-zapisanych"></div>
    </div>
  `).join('');
}

async function toggleZapisani(id) {
  const box = document.getElementById(`zapisani-${id}`);
  if (!box) return;

  if (!box.classList.contains('hidden')) { box.classList.add('hidden'); return; }

  box.classList.remove('hidden');
  box.innerHTML = '<div class="card" style="background:#222;">‚è≥ ≈Åadowanie...</div>';

  try {
    const lista = await apiClubGet("zapisani", { treningId: id });
    if (!Array.isArray(lista) || !lista.length) {
      box.innerHTML = '<div class="card" style="background:#111;">Brak zapisanych</div>';
      return;
    }
    box.innerHTML = `<div class="card" style="background:#111;">
      <b>Lista zapisanych:</b>
      <ul style="margin:6px 0 0 20px; padding:0; list-style-type:none;">
        ${lista.map(p => `<li>${p.nazwisko}</li>`).join('')}
      </ul>
    </div>`;
  } catch {
    box.innerHTML = '<div class="card" style="background:#700;">B≈ÇƒÖd pobierania listy</div>';
  }
}

async function zapiszSie(id) {
  const btn = document.getElementById(`btn-${id}`);
  const wypiszBtn = document.getElementById(`wypisz-${id}`);
  const box = document.getElementById(`zapisani-${id}`);

  btn.classList.add("loading");
  try {
    const r = await apiClubGet("zapisz", { numer: numerZalogowanego, treningId: id });
    if (r.ok) {
      btn.innerText = "Zapisano ‚úÖ";
      btn.disabled = true;
      wypiszBtn.disabled = false;
      if (box && !box.classList.contains("hidden")) await odswiezListeZapisanych(id);
    } else alert(r.message);
  } catch (err) {
    alert("B≈ÇƒÖd po≈ÇƒÖczenia: " + err);
  } finally {
    btn.classList.remove("loading");
  }
}

async function wypiszSie(id) {
  const btn = document.getElementById(`wypisz-${id}`);
  const zapiszBtn = document.getElementById(`btn-${id}`);
  const box = document.getElementById(`zapisani-${id}`);

  btn.classList.add("loading");
  try {
    const r = await apiClubGet("wypisz", { numer: numerZalogowanego, treningId: id });
    if (r.ok) {
      zapiszBtn.innerText = "Zapisz siƒô";
      zapiszBtn.disabled = false;
      btn.disabled = true;
      if (box && !box.classList.contains("hidden")) await odswiezListeZapisanych(id);
    } else alert(r.message);
  } catch (err) {
    alert("B≈ÇƒÖd po≈ÇƒÖczenia: " + err);
  } finally {
    btn.classList.remove("loading");
  }
}

async function odswiezListeZapisanych(id) {
  const box = document.getElementById(`zapisani-${id}`);
  if (!box) return;

  box.innerHTML = '<div class="card" style="background:#222;">‚è≥ Od≈õwie≈ºanie...</div>';
  try {
    const lista = await apiClubGet("zapisani", { treningId: id });
    if (!Array.isArray(lista) || !lista.length) {
      box.innerHTML = '<div class="card" style="background:#111;">Brak zapisanych</div>';
      return;
    }
    box.innerHTML = `<div class="card" style="background:#111;">
      <b>Lista zapisanych:</b>
      <ul style="margin:6px 0 0 20px; padding:0; list-style-type:none;">
        ${lista.map(p => `<li>${p.nazwisko}</li>`).join('')}
      </ul>
    </div>`;
  } catch {
    box.innerHTML = '<div class="card" style="background:#700;">B≈ÇƒÖd od≈õwie≈ºania</div>';
  }
}

/* =================== 90 TRENER: LISTA / WYDARZENIA / DODAWANIE / USUWANIE =================== */
function trainerPowrot() { appBack(); }

async function trainerPokazZawodnicy() {
  goToView("trainerZawodnicyView");
  const box = document.getElementById("trainerListaZawodnikow");
  box.innerHTML = "<div class='card' style='background:#222;'>‚è≥ ≈Åadowanie...</div>";

  try {
    const lista = await apiClubGet("statystykiSum", {});
    if (!Array.isArray(lista) || lista.length === 0) {
      box.innerHTML = "<div class='card' style='background:#111;'>Brak danych</div>";
      return;
    }

    box.innerHTML = lista.map(z => `
      <div class="card" style="text-align:left;">
        <b>#${z.nr}</b> ‚Äî ${z.nazwisko}<br>
        <span style="opacity:0.8;">${z.suma} trening√≥w ≈ÇƒÖcznie</span>
      </div>
    `).join('');
  } catch {
    box.innerHTML = "<div class='card' style='background:#700;'>B≈ÇƒÖd pobierania danych</div>";
  }
}

async function trainerPokazWydarzenia() {
  goToView("trainerWydarzeniaView");
  const lista = await apiClubGet("treningiTrener", { grupa: window.grupyTrenera || "" });
  renderTreningiTrainer(lista);
}

function renderTreningiTrainer(lista) {
  const div = document.getElementById("trainerListaWydarzen");
  if (!lista?.length) { div.innerHTML = "<p>Brak wydarze≈Ñ</p>"; return; }

  div.innerHTML = lista.map(t => `
    <div class="card" data-event-id="${t.miesiac}-${t.czasCol}">
      <b>${t.rodzaj}</b> ${t.data} (${t.dzien})<br>
      Godzina: <b>${t.godzStart}</b> ‚Äì <b>${t.godzKoniec}</b><br>
      Trener: <b>${t.trener}</b> | Zapisanych: ${t.zapisanych}<br><br>
      <button class="btn" onclick="trainerToggleZapisani('${t.id}')">üë• Zapisani</button>
      <button class="btn danger" onclick="trainerShowDeletePopup('${t.miesiac}', ${t.czasCol})">üóëÔ∏è Usu≈Ñ</button>
      <div id="trainer-zapisani-${t.id}" class="hidden"></div>
    </div>
  `).join('');
}

async function trainerToggleZapisani(id) {
  const box = document.getElementById(`trainer-zapisani-${id}`);
  if (!box) return;

  if (!box.classList.contains('hidden')) { box.classList.add('hidden'); return; }

  box.classList.remove('hidden');
  box.innerHTML = '<div class="card" style="background:#222;">‚è≥ ≈Åadowanie...</div>';

  try {
    const lista = await apiClubGet("zapisani", { treningId: id });
    if (!Array.isArray(lista) || !lista.length) {
      box.innerHTML = '<div class="card" style="background:#111;">Brak zapisanych</div>';
      return;
    }
    box.innerHTML = `<div class="card" style="background:#111;">
      <b>Lista zapisanych:</b>
      <ul style="margin:6px 0 0 20px; padding:0; list-style-type:none;">
        ${lista.map(p => `<li>${p.nazwisko}</li>`).join('')}
      </ul>
    </div>`;
  } catch {
    box.innerHTML = '<div class="card" style="background:#700;">B≈ÇƒÖd pobierania listy</div>';
  }
}

/* --- dodawanie wydarzenia --- */
async function zaladujListeTrenerow() {
  try {
    const lista = await apiClubGet("getTrenerzy", {});
    const t1 = document.getElementById("eventTrener1");
    const t2 = document.getElementById("eventTrener2");
    t1.innerHTML = "<option value=''>‚Äî wybierz trenera ‚Äî</option>";
    t2.innerHTML = "<option value=''>‚Äî Brak ‚Äî</option>";
    (lista || []).forEach(nazw => {
      t1.innerHTML += `<option value="${nazw}">${nazw}</option>`;
      t2.innerHTML += `<option value="${nazw}">${nazw}</option>`;
    });
  } catch {}
}

function pokazDodajWydarzenie() {
  goToView("trainerDodajWydarzenieView");
  zaladujListeTrenerow();
}
function validHour(hhmm) { return /^\d{2}:\d{2}$/.test(hhmm); }

async function wyslijNoweWydarzenie() {
  const data = document.getElementById("eventData").value;
  const start = document.getElementById("eventStart").value;
  const end = document.getElementById("eventEnd").value;
  const rodzaj = document.getElementById("eventRodzaj").value;
  const trener1 = document.getElementById("eventTrener1").value;
  const trener2 = document.getElementById("eventTrener2").value;

  const grupy = [...document.querySelectorAll(".eventGrupa:checked")].map(c => c.value).join(",");
  const liczDoStat = document.getElementById("eventStat").checked;
  const msg = document.getElementById("eventMsg");

  if (!data || !start || !rodzaj) { msg.innerText = "Uzupe≈Çnij: Data, Godzina, Rodzaj."; return; }
  if (!validHour(start) || !validHour(end)) { msg.innerText = "‚ùå Godzina w formacie HH:MM."; return; }
  if (start >= end) { msg.innerText = "‚ùå Koniec musi byƒá p√≥≈∫niej ni≈º start."; return; }

  msg.innerText = "‚è≥ Dodawanie wydarzenia...";
  try {
    const r = await apiClubPost({
      action: "dodajWydarzenie",
      data,
      godzStart: start,
      godzKoniec: end,
      rodzaj,
      trener1,
      trener2,
      grupy,
      liczDoStatystyk: String(liczDoStat)
    });

    msg.innerText = r.message || "Nieznany wynik.";

    if (r.success) {
      document.querySelectorAll("#trainerDodajWydarzenieView input").forEach(i => {
        if (i.type !== "checkbox") i.value = "";
        else i.checked = false;
      });
      setTimeout(() => trainerPokazWydarzenia(), 800);
    }
  } catch (err) {
    msg.innerText = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + err;
  }
}

/* --- usuwanie wydarzenia --- */
let deleteMiesiac = null;
let deleteCzasCol = null;

function trainerShowDeletePopup(miesiac, czasCol) {
  deleteMiesiac = miesiac;
  deleteCzasCol = czasCol;
  document.getElementById("trainerDeletePopup").classList.add("show");
}
function trainerHideDeletePopup() {
  document.getElementById("trainerDeletePopup").classList.remove("show");
}
async function trainerConfirmDeleteYes() {
  trainerHideDeletePopup();

  const treningId = `${deleteMiesiac}-${deleteCzasCol}`;
  const card = document.querySelector(`[data-event-id='${treningId}']`);
  if (card) card.innerHTML = `<div class="card" style="background:#222;text-align:center;">‚è≥ Usuwam wydarzenie‚Ä¶</div>`;

  try {
    const data = await apiClubGet("usunWydarzenie", { treningId });
    if (data.success) {
      if (card) card.innerHTML = `<div class="card" style="background:#152;text-align:center;">üóëÔ∏è Usuniƒôto</div>`;
      setTimeout(() => trainerPokazWydarzenia(), 800);
    } else {
      if (card) card.innerHTML = `<div class="card" style="background:#522;text-align:center;">‚ùå ${data.error || "B≈ÇƒÖd"}</div>`;
    }
  } catch (err) {
    if (card) card.innerHTML = `<div class="card" style="background:#522;text-align:center;">‚ùå ${err}</div>`;
  }
}

/* =================== 99 START APLIKACJI =================== */
window.addEventListener('load', () => {
  odtworzIntroSound();
  setTimeout(() => {
    const splash = document.getElementById('splash');
    const app = document.getElementById('app');
    if (splash) splash.style.display = 'none';
    if (app) app.classList.remove('hidden');

    const wersja = document.getElementById("wersjaNum");
    if (wersja) wersja.textContent = WERSJA_APKI;

    try {
      history.replaceState({ view: clubId ? "loginView" : "orgHubLandingView" }, "", "");
    } catch (e) {}

    startApp_();
  }, 5000);
});
</script>
</body>
</html>
