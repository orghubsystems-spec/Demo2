<script>
/* =================== 00 START / INTRO =================== */
function odtworzIntroSound() {
  try {
    const audio = new Audio("sound.mp3");
    audio.volume = 0.7;
    audio.play().catch(() => {});
  } catch (err) {}
}

/* =================== 10 KONFIG / GLOBALNE =================== */
const WERSJA_APKI = window.WERSJA_APKI || "ORGHUB APP";
const CORE_URL = "https://script.google.com/macros/s/AKfycbwn7Zb9uotc34HNLAsr79r5G5ctr2G2PzIxmZZFyQfeDD2Q8vecZCArQ-ezKVB5TcOexw/exec";

// stan aplikacji
let clubId = localStorage.getItem("orghub_clubId") || "";
let numerZalogowanego = null;
let grupaZalogowanego = null;
window.grupyTrenera = "";
let currentView = "loginView";

/* =================== 20 PAMIƒòƒÜ LOKALNA (localStorage) =================== */
const LS_KEY_CFG = "orghub.clubConfig.v1";
const LS_KEY_CLUBID = "orghub_clubId";
const LS_KEY_THEME = "orghub_theme";

function loadLocalClubConfig() {
  try { return JSON.parse(localStorage.getItem(LS_KEY_CFG) || "null"); }
  catch { return null; }
}
function saveLocalClubConfig(cfg) {
  localStorage.setItem(LS_KEY_CFG, JSON.stringify(cfg || {}));
}
function clearLocalClubConfig() {
  localStorage.removeItem(LS_KEY_CFG);
}
function saveClubId_(id) {
  clubId = String(id || "").trim();
  if (clubId) localStorage.setItem(LS_KEY_CLUBID, clubId);
  else localStorage.removeItem(LS_KEY_CLUBID);
}
function saveTheme_(theme) {
  localStorage.setItem(LS_KEY_THEME, JSON.stringify(theme || {}));
}
function loadTheme_() {
  try { return JSON.parse(localStorage.getItem(LS_KEY_THEME) || "null"); }
  catch { return null; }
}

/* =================== 30 BUSY OVERLAY =================== */
function showBusy(text) {
  const ov = document.getElementById("busyOverlay");
  const bt = document.getElementById("busyText");
  if (bt && text) bt.textContent = text;
  if (ov) ov.classList.remove("hidden");
}
function hideBusy() {
  const ov = document.getElementById("busyOverlay");
  if (ov) ov.classList.add("hidden");
}

/* =================== 40 NAWIGACJA / ROUTER =================== */
function ukryjWszystkie() {
  document.querySelectorAll(".container").forEach(v => v.classList.add("hidden"));
}

function goToView(viewId, options = {}) {
  const { replace = false } = options;
  ukryjWszystkie();
  const el = document.getElementById(viewId);
  if (el) el.classList.remove("hidden");
  currentView = viewId;

  const state = { view: viewId };
  try {
    if (replace) history.replaceState(state, "", "");
    else history.pushState(state, "", "");
  } catch (e) {}
}

function showViewFromHistory(viewId) {
  ukryjWszystkie();
  const el = document.getElementById(viewId);
  if (el) el.classList.remove("hidden");
  currentView = viewId;
}

function appBack() { history.back(); }

window.addEventListener("popstate", (event) => {
  const state = event.state;
  if (state && state.view) showViewFromHistory(state.view);
  else showViewFromHistory(clubId ? "loginView" : "orgHubLandingView");
});

function refreshClubBadge_() {
  const el = document.getElementById("clubIdBadge");
  if (el) el.textContent = clubId || "‚Äî";
}

function applyTheme_(theme) {
  try {
    if (theme?.bgColor) document.body.style.backgroundColor = theme.bgColor;

    const logoImg = document.querySelector("#loginView img.logo") || document.querySelector("#loginView img");
    if (logoImg && theme?.logoUrl) logoImg.src = theme.logoUrl;

  } catch (e) {}
}

function startApp_() {
  // zastosuj theme je≈õli jest
  const t = loadTheme_();
  if (t) applyTheme_(t);

  refreshClubBadge_();
  goToView(clubId ? "loginView" : "orgHubLandingView", { replace: true });
}

/* =================== 50 API (CORE / CLUB) =================== */
function requireClubId() {
  if (!clubId) throw new Error("Brak clubId. Najpierw skonfiguruj klub.");
}

// POST do CORE bez clubId (np. createClub)
async function apiCorePost(payload = {}) {
  const body = new URLSearchParams({ ...payload });
  const res = await fetch(CORE_URL, { method: "POST", body });
  return res.json();
}

// GET/POST do CLUB (wymaga clubId)
async function apiClubGet(action, params = {}) {
  requireClubId();
  const url = new URL(CORE_URL);
  url.searchParams.set("action", action);
  url.searchParams.set("clubId", clubId);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v ?? ""));
  const res = await fetch(url.toString(), { cache: "no-store" });
  return res.json();
}

async function apiClubPost(payload = {}) {
  requireClubId();
  const body = new URLSearchParams({ clubId, ...payload });
  const res = await fetch(CORE_URL, { method: "POST", body });
  return res.json();
}

/* =================== 60 ORGHUB START / KONFIGURACJA =================== */
// Tu masz dwa widoki: orgHubLandingView (start) i clubConfigView (panel)
// Docelowo zrobimy ‚Äúprzycisk zamienia siƒô w input‚Äù ‚Äî ale to bƒôdzie kolejny krok.

let cfgDraft = {
  clubName: "",
  email: "",
  sezonStart: "", // YYYY-MM-01
  sezonEnd: "",   // YYYY-MM-30 (tymczasowo)
  bgColor: "#000000",
  logoDataUrl: "" // dataURL
};

// paleta (wiƒôcej kolor√≥w zrobimy w nastƒôpnym kroku)
const COLOR_PRESETS = [
  "#000000","#111111","#1b1b1b","#2a2a2a",
  "#0b1220","#0f1a2b","#132235","#1a2f4a",
  "#1a0f1f","#2a1232","#3a1444","#4a1757",
  "#102015","#15301f","#1a4028","#205232",
];

function renderConfigUI_() {
  const nameEl = document.getElementById("cfgClubNameLabel");
  const ssEl = document.getElementById("cfgSeasonStartLabel");
  const seEl = document.getElementById("cfgSeasonEndLabel");
  const emEl = document.getElementById("cfgEmailLabel");
  const colEl = document.getElementById("cfgColorLabel");
  const prev = document.getElementById("cfgLogoPreview");
  const grid = document.getElementById("cfgColorGrid");

  if (nameEl) nameEl.textContent = cfgDraft.clubName ? `‚úÖ ${cfgDraft.clubName}` : "‚Äî nie ustawiono";
  if (ssEl) ssEl.textContent = cfgDraft.sezonStart ? `‚úÖ ${cfgDraft.sezonStart}` : "‚Äî nie ustawiono";
  if (seEl) seEl.textContent = cfgDraft.sezonEnd ? `‚úÖ ${cfgDraft.sezonEnd}` : "‚Äî nie ustawiono";
  if (emEl) emEl.textContent = cfgDraft.email ? `‚úÖ ${cfgDraft.email}` : "‚Äî nie ustawiono";
  if (colEl) colEl.textContent = cfgDraft.bgColor ? `‚úÖ ${cfgDraft.bgColor}` : "‚Äî nie ustawiono";

  if (prev) {
    if (cfgDraft.logoDataUrl) {
      prev.src = cfgDraft.logoDataUrl;
      prev.style.display = "inline-block";
    } else {
      prev.style.display = "none";
    }
  }

  if (grid) {
    grid.innerHTML = COLOR_PRESETS.map(c => `
      <div onclick="setBgColor('${c}')" style="
        width:100%; aspect-ratio:1/1; border-radius:10px;
        border:1px solid #444; background:${c}; cursor:pointer;">
      </div>
    `).join("");
  }
}

function goToConfig() {
  const saved = loadLocalClubConfig();
  if (saved) cfgDraft = { ...cfgDraft, ...saved };

  renderConfigUI_();
  goToView("clubConfigView");
}

function goBackFromConfig() {
  goToView(clubId ? "loginView" : "orgHubLandingView");
}

function toggleColorPicker(show) {
  const grid = document.getElementById("cfgColorGrid");
  if (!grid) return;
  if (show) grid.classList.remove("hidden");
  else grid.classList.add("hidden");
}

function setBgColor(color) {
  cfgDraft.bgColor = color;
  document.body.style.backgroundColor = color;
  const colEl = document.getElementById("cfgColorLabel");
  if (colEl) colEl.textContent = `‚úÖ ${color}`;
}

function pickLogo() {
  const input = document.getElementById("cfgLogoInput");
  if (!input) return;

  input.onchange = async () => {
    const file = input.files && input.files[0];
    if (!file) return;

    if (file.size > 2 * 1024 * 1024) {
      const msg = document.getElementById("cfgMsg");
      if (msg) msg.textContent = "‚ùå Logo za du≈ºe (max ~2MB).";
      return;
    }

    cfgDraft.logoDataUrl = await fileToDataUrl_(file);
    renderConfigUI_();
  };

  input.click();
}

function fileToDataUrl_(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result || ""));
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

// Tymczasowo jeszcze u≈ºywamy prompt√≥w. Ty chcesz inline-input w przycisku ‚Äî zrobimy w kolejnym kroku.
function editClubName() {
  const v = prompt("Podaj nazwƒô klubu:", cfgDraft.clubName || "");
  if (v === null) return;
  cfgDraft.clubName = v.trim();
  renderConfigUI_();
}
function editEmail() {
  const v = prompt("Podaj email admina:", cfgDraft.email || "");
  if (v === null) return;
  cfgDraft.email = v.trim();
  renderConfigUI_();
}
function editSeasonStart() {
  const v = prompt("PoczƒÖtek sezonu (RRRR-MM), np. 2026-09:", cfgDraft.sezonStart ? cfgDraft.sezonStart.slice(0,7) : "");
  if (v === null) return;
  const m = String(v).trim();
  if (!/^\d{4}-\d{2}$/.test(m)) {
    const msg = document.getElementById("cfgMsg");
    if (msg) msg.textContent = "‚ùå Z≈Çy format. U≈ºyj RRRR-MM.";
    return;
  }
  cfgDraft.sezonStart = `${m}-01`;
  renderConfigUI_();
}
function editSeasonEnd() {
  const v = prompt("Koniec sezonu (RRRR-MM), np. 2027-04:", cfgDraft.sezonEnd ? cfgDraft.sezonEnd.slice(0,7) : "");
  if (v === null) return;
  const m = String(v).trim();
  if (!/^\d{4}-\d{2}$/.test(m)) {
    const msg = document.getElementById("cfgMsg");
    if (msg) msg.textContent = "‚ùå Z≈Çy format. U≈ºyj RRRR-MM.";
    return;
  }
  cfgDraft.sezonEnd = `${m}-30`; // backend doprecyzuje
  renderConfigUI_();
}

/* =================== 61 WYS≈ÅANIE KONFIGURACJI -> CREATECLUB =================== */
function validateCfg_() {
  if (!cfgDraft.logoDataUrl) return "Wgraj logo.";
  if (!cfgDraft.clubName) return "Podaj nazwƒô klubu.";
  if (!cfgDraft.sezonStart) return "Podaj poczƒÖtek sezonu.";
  if (!cfgDraft.sezonEnd) return "Podaj koniec sezonu.";
  if (!cfgDraft.bgColor) return "Wybierz kolor t≈Ça.";
  if (!cfgDraft.email) return "Podaj email admina.";
  if (cfgDraft.sezonStart > cfgDraft.sezonEnd) return "PoczƒÖtek sezonu nie mo≈ºe byƒá po ko≈Ñcu sezonu.";
  return "";
}

async function submitClubConfig() {
  const msg = document.getElementById("cfgMsg");
  if (msg) msg.textContent = "";

  const err = validateCfg_();
  if (err) {
    if (msg) msg.textContent = "‚ùå " + err;
    return;
  }

  // zapis roboczy lokalnie (≈ºeby nie zginƒô≈Ço po od≈õwie≈ºeniu)
  saveLocalClubConfig({ ...cfgDraft });

  showBusy("Tworzƒô pliki klubu i konfiguracjƒô sezonu‚Ä¶");

  try {
    const r = await apiCorePost({
      action: "createClub",
      clubName: cfgDraft.clubName,
      sezonStart: cfgDraft.sezonStart,
      sezonEnd: cfgDraft.sezonEnd,
      bgColor: cfgDraft.bgColor,
      ownerEmail: cfgDraft.email,
      logoBase64: cfgDraft.logoDataUrl
    });

    if (!r || (r.success !== true && r.ok !== true)) {
      hideBusy();
      if (msg) msg.textContent = "‚ùå " + (r?.error || r?.message || JSON.stringify(r));
      return;
    }

    if (!r.clubId) {
      hideBusy();
      if (msg) msg.textContent = "‚ùå CORE nie zwr√≥ci≈Ç clubId.";
      return;
    }

    // ustaw clubId
    saveClubId_(r.clubId);

    // theme
    const theme = {
      bgColor: r.bgColor || cfgDraft.bgColor,
      logoUrl: r.logoUrl || cfgDraft.logoDataUrl, // je≈õli CORE nie hostuje jeszcze logo, u≈ºyj dataUrl
      clubName: r.clubName || cfgDraft.clubName
    };
    saveTheme_(theme);
    applyTheme_(theme);

    // utrwal config (z clubId)
    saveLocalClubConfig({ ...cfgDraft, clubId: r.clubId });

    hideBusy();
    if (msg) msg.textContent = "‚úÖ Gotowe. Przechodzƒô do logowania‚Ä¶";

    refreshClubBadge_();
    setTimeout(() => goToView("loginView", { replace:true }), 400);

  } catch (e) {
    hideBusy();
    if (msg) msg.textContent = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e);
  }
}

/* =================== 70 LOGOWANIE / REJESTRACJA =================== */
function pokazLogowanie() {
  numerZalogowanego = null;
  grupaZalogowanego = null;
  window.grupyTrenera = "";
  refreshClubBadge_();
  goToView("loginView");
}
function pokazRejestracjaSelect() { goToView("registerSelectView"); }
function pokazRejestracjaZawodnik() { goToView("registerZawodnikView"); }
function pokazRejestracjaTrener() { goToView("rejestracjaTrenerView"); }

async function zaloguj() {
  const login = document.getElementById("numer").value.trim();
  const haslo = document.getElementById("haslo").value.trim();
  const komunikat = document.getElementById("komunikat");

  if (!clubId) { komunikat.innerText = "Najpierw skonfiguruj klub."; goToView("orgHubLandingView"); return; }
  if (!login || !haslo) { komunikat.innerText = "Podaj login i has≈Ço."; return; }

  komunikat.innerText = "Trwa logowanie...";

  try {
    const data = await apiClubPost({ mode: "login", numer: login, haslo });

    if (!data.success) {
      komunikat.innerText = "‚ùå " + (data.message || "B≈ÇƒÖd logowania");
      return;
    }

    komunikat.innerText = "‚úÖ Zalogowano";

    if (data.role === "zawodnik") {
      numerZalogowanego = data.login;
      grupaZalogowanego = data.grupa || "";

      const platnosci = await apiClubGet("platnosci", { numer: numerZalogowanego });
      if (Array.isArray(platnosci) && platnosci.length > 0) {
        goToView("platnosciView");
        renderPlatnosci(platnosci);
        return;
      }

      await pokazTreningi();
      return;
    }

    if (data.role === "trener") {
      window.grupyTrenera = data.grupa || "";
      goToView("trainerPanelView");
      return;
    }

  } catch (e) {
    komunikat.innerText = "B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e);
  }
}

/* =================== 75 REJESTRACJA =================== */
async function wyslijRejestracje() {
  const numer = document.getElementById("regNumer").value.trim();
  const nazwisko = document.getElementById("regNazwisko").value.trim();
  const haslo = document.getElementById("regHaslo").value.trim();
  const msg = document.getElementById("regMsg");

  if (!numer || !nazwisko || !haslo) { msg.innerText = "Wype≈Çnij wszystkie pola."; return; }

  msg.innerText = "‚è≥ Rejestracja...";
  try {
    const data = await apiClubPost({ mode: "rejestracja", numer, nazwisko, haslo });

    if (data.ok) {
      document.getElementById("regNumer").value = "";
      document.getElementById("regNazwisko").value = "";
      document.getElementById("regHaslo").value = "";
      msg.innerText = "‚úÖ Rejestracja zako≈Ñczona!";
      setTimeout(() => { msg.innerText = ""; pokazLogowanie(); }, 1500);
    } else {
      msg.innerText = "‚ùå " + (data.msg || "B≈ÇƒÖd");
    }
  } catch (e) {
    msg.innerText = "B≈ÇƒÖd po≈ÇƒÖczenia.";
  }
}

async function wyslijRejestracjeTrener() {
  const poleNazw = document.getElementById("regNazwiskoTrener");
  const poleHaslo = document.getElementById("regHasloTrener");
  const msg = document.getElementById("regMsgTrener");

  const nazwisko = poleNazw.value.trim();
  const haslo = poleHaslo.value.trim();
  if (!nazwisko || !haslo) { msg.innerText = "Wype≈Çnij wszystkie pola."; return; }

  msg.innerText = "‚è≥ Rejestracja...";
  try {
    const data = await apiClubPost({ mode: "rejestracjaTrener", nazwisko, haslo });

    if (data.ok) {
      const inic = data.inic || "(?)";
      msg.innerHTML = `
        ‚úÖ <b>Zarejestrowano trenera!</b><br>
        Login do systemu: <b>${inic}</b><br><br>
        <button class="full-btn" onclick="navigator.clipboard.writeText('${inic}')">üìã Skopiuj login</button>
      `;
      poleNazw.value = "";
      poleHaslo.value = "";
      setTimeout(() => { msg.innerText = ""; pokazLogowanie(); }, 8000);
    } else {
      msg.innerText = "‚ùå " + (data.msg || "B≈ÇƒÖd");
    }
  } catch (e) {
    msg.innerText = "B≈ÇƒÖd po≈ÇƒÖczenia.";
  }
}

/* =================== 80 ZAWODNIK: TRENINGI / ZAPISY =================== */
function renderPlatnosci(lista) {
  const div = document.getElementById("listaPlatnosci");
  if (!lista?.length) {
    div.innerHTML = "<p>Brak zaleg≈Ço≈õci ‚úÖ</p>" +
      "<button class='full-btn' onclick='pokazTreningi()'>Dalej ‚û°</button>";
    return;
  }

  div.innerHTML =
    "<h3>Zaleg≈Çe p≈Çatno≈õci:</h3>" +
    lista.map(p => `<div class='card' style='background:#a00;'>üî¥ ${p.nazwa} ‚Äì ${p.kwota} z≈Ç</div>`).join('') +
    `<button class='full-btn' onclick='pokazTreningi()' style='margin-top:20px;'>Dalej ‚û°</button>`;
}

async function pokazTreningi() {
  goToView("homeView");
  const lista = await apiClubGet("treningi", { grupa: grupaZalogowanego, numer: numerZalogowanego });
  renderTreningi(lista);
}

function renderTreningi(lista) {
  const div = document.getElementById('listaTreningow');
  if (!lista?.length) { div.innerHTML = "<p>Brak wydarze≈Ñ</p>"; return; }

  div.innerHTML = lista.map(t => `
    <div class="card">
      <p>
        <b>${t.rodzaj}</b> &nbsp;&nbsp; ${t.data} (${t.dzien})<br>
        Godzina: <b>${t.godzStart}</b> ‚Äì <b>${t.godzKoniec}</b><br>
        Trener: <b>${t.trener}</b> &nbsp;&nbsp; Zapisanych: ${t.zapisanych}
      </p>

      <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;">
        <button id="btn-${t.id}" ${t.zapisany ? 'disabled' : ''} onclick="zapiszSie('${t.id}')">
          ${t.zapisany ? 'Zapisano ‚úÖ' : 'Zapisz siƒô'}
        </button>
        <button id="wypisz-${t.id}" ${t.zapisany ? '' : 'disabled'} style="background:#444;" onclick="wypiszSie('${t.id}')">
          Wypisz siƒô
        </button>
        <button style="background:#333;" onclick="toggleZapisani('${t.id}')">üë• Zapisani</button>
      </div>

      <div id="zapisani-${t.id}" class="hidden lista-zapisanych"></div>
    </div>
  `).join('');
}

async function toggleZapisani(id) {
  const box = document.getElementById(`zapisani-${id}`);
  if (!box) return;

  if (!box.classList.contains('hidden')) { box.classList.add('hidden'); return; }

  box.classList.remove('hidden');
  box.innerHTML = '<div class="card" style="background:#222;">‚è≥ ≈Åadowanie...</div>';

  try {
    const lista = await apiClubGet("zapisani", { treningId: id });
    if (!Array.isArray(lista) || !lista.length) {
      box.innerHTML = '<div class="card" style="background:#111;">Brak zapisanych</div>';
      return;
    }
    box.innerHTML = `<div class="card" style="background:#111;">
      <b>Lista zapisanych:</b>
      <ul style="margin:6px 0 0 20px; padding:0; list-style-type:none;">
        ${lista.map(p => `<li>${p.nazwisko}</li>`).join('')}
      </ul>
    </div>`;
  } catch {
    box.innerHTML = '<div class="card" style="background:#700;">B≈ÇƒÖd pobierania listy</div>';
  }
}

async function zapiszSie(id) {
  const btn = document.getElementById(`btn-${id}`);
  const wypiszBtn = document.getElementById(`wypisz-${id}`);
  const box = document.getElementById(`zapisani-${id}`);

  btn.classList.add("loading");
  try {
    const r = await apiClubGet("zapisz", { numer: numerZalogowanego, treningId: id });
    if (r.ok) {
      btn.innerText = "Zapisano ‚úÖ";
      btn.disabled = true;
      wypiszBtn.disabled = false;
      if (box && !box.classList.contains("hidden")) await odswiezListeZapisanych(id);
    } else alert(r.message);
  } catch (err) {
    alert("B≈ÇƒÖd po≈ÇƒÖczenia: " + err);
  } finally {
    btn.classList.remove("loading");
  }
}

async function wypiszSie(id) {
  const btn = document.getElementById(`wypisz-${id}`);
  const zapiszBtn = document.getElementById(`btn-${id}`);
  const box = document.getElementById(`zapisani-${id}`);

  btn.classList.add("loading");
  try {
    const r = await apiClubGet("wypisz", { numer: numerZalogowanego, treningId: id });
    if (r.ok) {
      zapiszBtn.innerText = "Zapisz siƒô";
      zapiszBtn.disabled = false;
      btn.disabled = true;
      if (box && !box.classList.contains("hidden")) await odswiezListeZapisanych(id);
    } else alert(r.message);
  } catch (err) {
    alert("B≈ÇƒÖd po≈ÇƒÖczenia: " + err);
  } finally {
    btn.classList.remove("loading");
  }
}

async function odswiezListeZapisanych(id) {
  const box = document.getElementById(`zapisani-${id}`);
  if (!box) return;

  box.innerHTML = '<div class="card" style="background:#222;">‚è≥ Od≈õwie≈ºanie...</div>';
  try {
    const lista = await apiClubGet("zapisani", { treningId: id });
    if (!Array.isArray(lista) || !lista.length) {
      box.innerHTML = '<div class="card" style="background:#111;">Brak zapisanych</div>';
      return;
    }
    box.innerHTML = `<div class="card" style="background:#111;">
      <b>Lista zapisanych:</b>
      <ul style="margin:6px 0 0 20px; padding:0; list-style-type:none;">
        ${lista.map(p => `<li>${p.nazwisko}</li>`).join('')}
      </ul>
    </div>`;
  } catch {
    box.innerHTML = '<div class="card" style="background:#700;">B≈ÇƒÖd od≈õwie≈ºania</div>';
  }
}

/* =================== 90 TRENER: LISTA / WYDARZENIA / DODAWANIE / USUWANIE =================== */
function trainerPowrot() { appBack(); }

async function trainerPokazZawodnicy() {
  goToView("trainerZawodnicyView");
  const box = document.getElementById("trainerListaZawodnikow");
  box.innerHTML = "<div class='card' style='background:#222;'>‚è≥ ≈Åadowanie...</div>";

  try {
    const lista = await apiClubGet("statystykiSum", {});
    if (!Array.isArray(lista) || lista.length === 0) {
      box.innerHTML = "<div class='card' style='background:#111;'>Brak danych</div>";
      return;
    }

    box.innerHTML = lista.map(z => `
      <div class="card" style="text-align:left;">
        <b>#${z.nr}</b> ‚Äî ${z.nazwisko}<br>
        <span style="opacity:0.8;">${z.suma} trening√≥w ≈ÇƒÖcznie</span>
      </div>
    `).join('');
  } catch {
    box.innerHTML = "<div class='card' style='background:#700;'>B≈ÇƒÖd pobierania danych</div>";
  }
}

async function trainerPokazWydarzenia() {
  goToView("trainerWydarzeniaView");
  const lista = await apiClubGet("treningiTrener", { grupa: window.grupyTrenera || "" });
  renderTreningiTrainer(lista);
}

function renderTreningiTrainer(lista) {
  const div = document.getElementById("trainerListaWydarzen");
  if (!lista?.length) { div.innerHTML = "<p>Brak wydarze≈Ñ</p>"; return; }

  div.innerHTML = lista.map(t => `
    <div class="card" data-event-id="${t.miesiac}-${t.czasCol}">
      <b>${t.rodzaj}</b> ${t.data} (${t.dzien})<br>
      Godzina: <b>${t.godzStart}</b> ‚Äì <b>${t.godzKoniec}</b><br>
      Trener: <b>${t.trener}</b> | Zapisanych: ${t.zapisanych}<br><br>
      <button class="btn" onclick="trainerToggleZapisani('${t.id}')">üë• Zapisani</button>
      <button class="btn danger" onclick="trainerShowDeletePopup('${t.miesiac}', ${t.czasCol})">üóëÔ∏è Usu≈Ñ</button>
      <div id="trainer-zapisani-${t.id}" class="hidden"></div>
    </div>
  `).join('');
}

async function trainerToggleZapisani(id) {
  const box = document.getElementById(`trainer-zapisani-${id}`);
  if (!box) return;

  if (!box.classList.contains('hidden')) { box.classList.add('hidden'); return; }

  box.classList.remove('hidden');
  box.innerHTML = '<div class="card" style="background:#222;">‚è≥ ≈Åadowanie...</div>';

  try {
    const lista = await apiClubGet("zapisani", { treningId: id });
    if (!Array.isArray(lista) || !lista.length) {
      box.innerHTML = '<div class="card" style="background:#111;">Brak zapisanych</div>';
      return;
    }
    box.innerHTML = `<div class="card" style="background:#111;">
      <b>Lista zapisanych:</b>
      <ul style="margin:6px 0 0 20px; padding:0; list-style-type:none;">
        ${lista.map(p => `<li>${p.nazwisko}</li>`).join('')}
      </ul>
    </div>`;
  } catch {
    box.innerHTML = '<div class="card" style="background:#700;">B≈ÇƒÖd pobierania listy</div>';
  }
}

/* --- dodawanie wydarzenia --- */
async function zaladujListeTrenerow() {
  try {
    const lista = await apiClubGet("getTrenerzy", {});
    const t1 = document.getElementById("eventTrener1");
    const t2 = document.getElementById("eventTrener2");
    t1.innerHTML = "<option value=''>‚Äî wybierz trenera ‚Äî</option>";
    t2.innerHTML = "<option value=''>‚Äî Brak ‚Äî</option>";
    (lista || []).forEach(nazw => {
      t1.innerHTML += `<option value="${nazw}">${nazw}</option>`;
      t2.innerHTML += `<option value="${nazw}">${nazw}</option>`;
    });
  } catch {}
}

function pokazDodajWydarzenie() {
  goToView("trainerDodajWydarzenieView");
  zaladujListeTrenerow();
}
function validHour(hhmm) { return /^\d{2}:\d{2}$/.test(hhmm); }

async function wyslijNoweWydarzenie() {
  const data = document.getElementById("eventData").value;
  const start = document.getElementById("eventStart").value;
  const end = document.getElementById("eventEnd").value;
  const rodzaj = document.getElementById("eventRodzaj").value;
  const trener1 = document.getElementById("eventTrener1").value;
  const trener2 = document.getElementById("eventTrener2").value;

  const grupy = [...document.querySelectorAll(".eventGrupa:checked")].map(c => c.value).join(",");
  const liczDoStat = document.getElementById("eventStat").checked;
  const msg = document.getElementById("eventMsg");

  if (!data || !start || !rodzaj) { msg.innerText = "Uzupe≈Çnij: Data, Godzina, Rodzaj."; return; }
  if (!validHour(start) || !validHour(end)) { msg.innerText = "‚ùå Godzina w formacie HH:MM."; return; }
  if (start >= end) { msg.innerText = "‚ùå Koniec musi byƒá p√≥≈∫niej ni≈º start."; return; }

  msg.innerText = "‚è≥ Dodawanie wydarzenia...";
  try {
    const r = await apiClubPost({
      action: "dodajWydarzenie",
      data,
      godzStart: start,
      godzKoniec: end,
      rodzaj,
      trener1,
      trener2,
      grupy,
      liczDoStatystyk: String(liczDoStat)
    });

    msg.innerText = r.message || "Nieznany wynik.";

    if (r.success) {
      document.querySelectorAll("#trainerDodajWydarzenieView input").forEach(i => {
        if (i.type !== "checkbox") i.value = "";
        else i.checked = false;
      });
      setTimeout(() => trainerPokazWydarzenia(), 800);
    }
  } catch (err) {
    msg.innerText = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + err;
  }
}

/* --- usuwanie wydarzenia --- */
let deleteMiesiac = null;
let deleteCzasCol = null;

function trainerShowDeletePopup(miesiac, czasCol) {
  deleteMiesiac = miesiac;
  deleteCzasCol = czasCol;
  document.getElementById("trainerDeletePopup").classList.add("show");
}
function trainerHideDeletePopup() {
  document.getElementById("trainerDeletePopup").classList.remove("show");
}
async function trainerConfirmDeleteYes() {
  trainerHideDeletePopup();

  const treningId = `${deleteMiesiac}-${deleteCzasCol}`;
  const card = document.querySelector(`[data-event-id='${treningId}']`);
  if (card) card.innerHTML = `<div class="card" style="background:#222;text-align:center;">‚è≥ Usuwam wydarzenie‚Ä¶</div>`;

  try {
    const data = await apiClubGet("usunWydarzenie", { treningId });
    if (data.success) {
      if (card) card.innerHTML = `<div class="card" style="background:#152;text-align:center;">üóëÔ∏è Usuniƒôto</div>`;
      setTimeout(() => trainerPokazWydarzenia(), 800);
    } else {
      if (card) card.innerHTML = `<div class="card" style="background:#522;text-align:center;">‚ùå ${data.error || "B≈ÇƒÖd"}</div>`;
    }
  } catch (err) {
    if (card) card.innerHTML = `<div class="card" style="background:#522;text-align:center;">‚ùå ${err}</div>`;
  }
}

/* =================== 99 START APLIKACJI =================== */
window.addEventListener('load', () => {
  odtworzIntroSound();
  setTimeout(() => {
    const splash = document.getElementById('splash');
    const app = document.getElementById('app');
    if (splash) splash.style.display = 'none';
    if (app) app.classList.remove('hidden');

    const wersja = document.getElementById("wersjaNum");
    if (wersja) wersja.textContent = WERSJA_APKI;

    try {
      history.replaceState({ view: clubId ? "loginView" : "orgHubLandingView" }, "", "");
    } catch (e) {}

    startApp_();
  }, 5000);
});
</script>
